
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <meta name="author" content="IBM Developer">
      
      
        <link rel="canonical" href="https://timroster.github.io/digidevcon-iks/exercise-5/">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.2.8">
    
    
      
        <title>Deploy the Guestbook Application with the Tone Analyzer - Digital Developer Conference Kubernetes Lab</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.cb6bc1d0.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.39b8e14a.min.css">
        
          
          
          <meta name="theme-color" content="#2094f3">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=IBM+Plex+Sans:300,400,400i,700%7CIBM+Plex+Mono&display=fallback">
        <style>body,input{font-family:"IBM Plex Sans",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"IBM Plex Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="blue">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#deploy-the-guestbook-application-with-the-tone-analyzer" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://timroster.github.io/digidevcon-iks" title="Digital Developer Conference Kubernetes Lab" class="md-header-nav__button md-logo" aria-label="Digital Developer Conference Kubernetes Lab">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      <div class="md-header-nav__ellipsis">
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            Digital Developer Conference Kubernetes Lab
          </span>
        </div>
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            
              Deploy the Guestbook Application with the Tone Analyzer
            
          </span>
        </div>
      </div>
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/timroster/digidevcon-iks/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    digidevcon-iks
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    




<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://timroster.github.io/digidevcon-iks" title="Digital Developer Conference Kubernetes Lab" class="md-nav__button md-logo" aria-label="Digital Developer Conference Kubernetes Lab">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Digital Developer Conference Kubernetes Lab
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/timroster/digidevcon-iks/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    digidevcon-iks
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        About the workshop
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../exercise-0a/" class="md-nav__link">
        Kubernetes Cluster setup
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../exercise-0b/" class="md-nav__link">
        Lab setup - get web terminal and content
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../exercise-1/" class="md-nav__link">
        Deploy an application on Kubernetes
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../exercise-2/" class="md-nav__link">
        Scale and Update Deployments
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../exercise-3/" class="md-nav__link">
        Installing the IBM Cloud Operator
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../exercise-4/" class="md-nav__link">
        Creating an instance of Tone Analyzer
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Deploy the Guestbook Application with the Tone Analyzer
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Deploy the Guestbook Application with the Tone Analyzer
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    Setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-the-redis-master-pod" class="md-nav__link">
    Create the Redis master pod
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-the-redis-master-service" class="md-nav__link">
    Create the Redis master service
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-the-redis-slave-pods" class="md-nav__link">
    Create the Redis slave pods
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-the-redis-slave-service" class="md-nav__link">
    Create the Redis slave service
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-the-guestbook-pods" class="md-nav__link">
    Create the guestbook pods
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-and-expose-the-guestbook-service" class="md-nav__link">
    Create and expose the guestbook service
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-the-analyzer-pod" class="md-nav__link">
    Create the analyzer pod
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-the-analyzer-service" class="md-nav__link">
    Create the analyzer service
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#view-the-guestbook" class="md-nav__link">
    View the guestbook
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cleanup" class="md-nav__link">
    Cleanup
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    Setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-the-redis-master-pod" class="md-nav__link">
    Create the Redis master pod
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-the-redis-master-service" class="md-nav__link">
    Create the Redis master service
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-the-redis-slave-pods" class="md-nav__link">
    Create the Redis slave pods
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-the-redis-slave-service" class="md-nav__link">
    Create the Redis slave service
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-the-guestbook-pods" class="md-nav__link">
    Create the guestbook pods
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-and-expose-the-guestbook-service" class="md-nav__link">
    Create and expose the guestbook service
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-the-analyzer-pod" class="md-nav__link">
    Create the analyzer pod
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-the-analyzer-service" class="md-nav__link">
    Create the analyzer service
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#view-the-guestbook" class="md-nav__link">
    View the guestbook
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cleanup" class="md-nav__link">
    Cleanup
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/timroster/digidevcon-iks/edit/main/workshop/exercise-5/README.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="deploy-the-guestbook-application-with-the-tone-analyzer">Deploy the Guestbook Application with the Tone Analyzer<a class="headerlink" href="#deploy-the-guestbook-application-with-the-tone-analyzer" title="Permanent link">&para;</a></h1>
<p>In this section, you will re-create the guestbook application, but this time with more components in a multi-tier architecture. This application uses the <code>v2</code> version of the go application we used previously in the workshop as our web front end, and adds on 1) a Redis master for storage, 2) a replicated set of Redis slaves, and 3) a Python Flask application that calls the Watson Tone Analyzer service deployed in IBM Cloud. For all of these components, there are Kubernetes replication controllers, pods, and services. One of the main concerns with building a multi-tier application on Kubernetes, such as this one, is resolving dependencies between all of these seperately deployed components.</p>
<p>In a multiple tier application, there are two primary ways that service dependencies can be resolved. The <a href="../../v2/guestbook/main.go"><code>v2/guestbook/main.go</code></a> code provides examples of each. For Redis, the master endpoint is discovered through environment variables. These environment variables are set when the Redis services are started, so the service resources need to be created before the guestbook replication controller starts the guestbook pods. For the analyzer service, an http request is made to a hostname, which allows for resource discovery at the time when the request is made. Consequently, we'll follow a specific order when creating the application components. First up, the Redis components will be created, then the guestbook application, and finally the analyzer microservice.</p>
<h2 id="setup">Setup<a class="headerlink" href="#setup" title="Permanent link">&para;</a></h2>
<p>Continue by working in the web terminal. Change to the <code>v2</code> folder where the deployment files reside:</p>
<div class="highlight"><pre><span></span><code>cd $HOME/digidevcon-iks/v2
</code></pre></div>
<h2 id="create-the-redis-master-pod">Create the Redis master pod<a class="headerlink" href="#create-the-redis-master-pod" title="Permanent link">&para;</a></h2>
<p>Use the <code>redis-master-deployment.yaml</code> file to create a <a href="https://kubernetes.io/docs/concepts/workloads/controllers/replicationcontroller/">replication controller</a> and Redis master <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/">pod</a>. The pod runs a Redis key-value server in a container. Using a replication controller is the preferred way to launch long-running pods, even for 1 replica, so that the pod inherits benefits from the self-healing mechanism in Kubernetes (i.e. keeps the pods alive).</p>
<ol>
<li>
<p>Use the <a href="../../v2/redis-master-deployment.yaml">redis-master-deployment.yaml</a> file to create the Redis master deployment in your Kubernetes cluster:</p>
<div class="highlight"><pre><span></span><code>kubectl create -f redis-master-deployment.yaml
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>kubectl create -f redis-master-deployment.yaml
<span class="go">deployment.apps/redis-master created</span>
</code></pre></div>
</li>
<li>
<p>To verify that the redis-master controller is up, list the deployment and replicaset you created in the cluster with the <code>kubectl get</code> command (if you don't specify a <code>--namespace</code>, the current project/namespace will be used):</p>
<div class="highlight"><pre><span></span><code>kubectl get deploy
</code></pre></div>
<p>this will show the current deployments in the namespace</p>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>kubectl get deploy
<span class="go">NAME           READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="go">redis-master   1/1     1            1           15s</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>kubectl get replicaset
</code></pre></div>
<p>this will show the current deployments in the namespace</p>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>kubectl get replicaset
<span class="go">NAME                      DESIRED   CURRENT   READY   AGE</span>
<span class="go">redis-master-7b7968db76   1         1         1       41s</span>
</code></pre></div>
<p>Result: The deployment creates the replicaset, which then creates the single Redis master pod.</p>
</li>
<li>
<p>Verify that the redis-master pod is running, by listing the pods you created in cluster:</p>
<div class="highlight"><pre><span></span><code>kubectl get pods
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>kubectl get pods
<span class="go">NAME                            READY   STATUS    RESTARTS   AGE</span>
<span class="go">redis-master-7b7968db76-8mjqg   1/1     Running   0          67s</span>
</code></pre></div>
<p>Result: You'll see a single Redis master pod (may take up to thirty seconds).</p>
</li>
</ol>
<h2 id="create-the-redis-master-service">Create the Redis master service<a class="headerlink" href="#create-the-redis-master-service" title="Permanent link">&para;</a></h2>
<p>A Kubernetes <a href="https://kubernetes.io/docs/concepts/services-networking/service/">service</a> is a named load balancer that proxies traffic to one or more pods. The services in a Kubernetes cluster are discoverable inside other pods via environment variables or DNS.</p>
<p>Services find the pods to load balance based on pod labels. The pod that you created in previous step has the label <code>app=redis</code> and <code>role=master</code>. The selector field of the service determines which pods will receive the traffic sent to the service.</p>
<ol>
<li>
<p>Use the <a href="../../v2/redis-master-service.yaml">redis-master-service.yaml</a> file to create the service in your Kubernetes cluster:</p>
<div class="highlight"><pre><span></span><code>kubectl create -f redis-master-service.yaml
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>kubectl create -f redis-master-service.yaml
<span class="go">service/redis-master created</span>
</code></pre></div>
</li>
<li>
<p>To verify that the redis-master service is up, list the services you created in the cluster:</p>
<div class="highlight"><pre><span></span><code>kubectl get services
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>kubectl get services
<span class="go">NAME           TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)    AGE</span>
<span class="go">kubernetes     ClusterIP   172.21.0.1    &lt;none&gt;        443/TCP    8h</span>
<span class="go">redis-master   ClusterIP   172.21.36.3   &lt;none&gt;        6379/TCP   10s</span>
<span class="go">...</span>
</code></pre></div>
<p>Result: All new pods will see the <code>redis-master</code> service running on the host (<code>$REDIS_MASTER_SERVICE_HOST</code> environment variable) at port <code>6379</code>, or running on <code>redis-master:6379</code>. After the service is created, the service proxy on each node is configured to set up a proxy on the specified port (in our example, that's port <code>6379</code>).</p>
</li>
</ol>
<h2 id="create-the-redis-slave-pods">Create the Redis slave pods<a class="headerlink" href="#create-the-redis-slave-pods" title="Permanent link">&para;</a></h2>
<p>The Redis master we created earlier is a single pod (REPLICAS = 1), while the Redis read slaves we are creating here are 'replicated' pods with 2 instances that will be started. In Kubernetes, a replication controller is responsible for managing the multiple instances of a replicated pod.</p>
<ol>
<li>
<p>Use the file <a href="../../v2/redis-slave-deployment.yaml">redis-slave-deployment.yaml</a> to create the replication controller:</p>
<div class="highlight"><pre><span></span><code>kubectl create -f redis-slave-deployment.yaml
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>kubectl create -f redis-slave-deployment.yaml
<span class="go">deployment.apps/redis-slave created</span>
</code></pre></div>
</li>
<li>
<p>To verify that the redis-slave controller is running:</p>
<div class="highlight"><pre><span></span><code>kubectl get rs
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>kubectl get rs
<span class="go">NAME                      DESIRED   CURRENT   READY   AGE</span>
<span class="go">redis-master-7b7968db76   1         1         1       2m48s</span>
<span class="go">redis-slave-6944587c87    2         2         2       36s</span>
</code></pre></div>
<p>Result: The deployment creates the replicaset, which then creates configures the Redis slave pods through the redis-master service (name:port pair, in our example that's <code>redis-master:6379</code>).</p>
</li>
<li>
<p>Verify that the Redis master and slaves pods are running:</p>
<div class="highlight"><pre><span></span><code>kubectl get pods
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>kubectl get pods
<span class="go">NAME                            READY   STATUS    RESTARTS   AGE</span>
<span class="go">redis-master-7b7968db76-8mjqg   1/1     Running   0          3m25s</span>
<span class="go">redis-slave-6944587c87-4gvgj    1/1     Running   0          73s</span>
<span class="go">redis-slave-6944587c87-h66wp    1/1     Running   0          73s</span>
<span class="go">...</span>
</code></pre></div>
<p>Result: You see the single Redis master and two Redis slave pods.</p>
</li>
</ol>
<h2 id="create-the-redis-slave-service">Create the Redis slave service<a class="headerlink" href="#create-the-redis-slave-service" title="Permanent link">&para;</a></h2>
<p>Just like the master, we want to have a service to proxy connections to the read slaves. In this case, in addition to discovery, the Redis slave service provides transparent load balancing to clients.</p>
<ol>
<li>
<p>Use the <a href="../../v2/redis-slave-service.yaml">redis-slave-service.yaml</a> file to create the Redis slave service:</p>
<div class="highlight"><pre><span></span><code>kubectl create -f redis-slave-service.yaml
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>kubectl create -f redis-slave-service.yaml
<span class="go">service/redis-slave created</span>
</code></pre></div>
</li>
<li>
<p>To verify that the redis-slave service is up, list the services you created:</p>
<div class="highlight"><pre><span></span><code>kubectl get services
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>kubectl get services
<span class="go">NAME           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span>
<span class="go">kubernetes     ClusterIP   172.21.0.1      &lt;none&gt;        443/TCP    8h</span>
<span class="go">redis-master   ClusterIP   172.21.36.3     &lt;none&gt;        6379/TCP   2m32s</span>
<span class="go">redis-slave    ClusterIP   172.21.251.35   &lt;none&gt;        6379/TCP   7s</span>
</code></pre></div>
<p>Result: The service is created and accessible at <code>redis-slave:6379</code> by pods running in the project</p>
</li>
</ol>
<h2 id="create-the-guestbook-pods">Create the guestbook pods<a class="headerlink" href="#create-the-guestbook-pods" title="Permanent link">&para;</a></h2>
<p>This is a simple Go <code>net/http</code> (<a href="https://github.com/codegangsta/negroni">negroni</a> based) server that is configured to talk to either the slave or master services depending on whether the request is a read or a write. The pods we are creating expose a simple JSON interface and serves a jQuery-Ajax based UI. Like the Redis read slaves, these pods are also managed by a replication controller.</p>
<ol>
<li>
<p>Use the <a href="../../v2/guestbook-deployment.yaml">guestbook-deployment.yaml</a> file to create the guestbook replication controller:</p>
<div class="highlight"><pre><span></span><code>kubectl create -f guestbook-deployment.yaml
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>kubectl create -f guestbook-deployment.yaml
<span class="go">deployment.apps/guestbook-v2 created</span>
</code></pre></div>
<blockquote>
<p>Tip: If you want to modify the guestbook code it can be found in the <code>guestbook</code> directory, along with its Makefile. If you have pushed your custom image be sure to update the <code>image</code> property accordingly in the guestbook-deployment.yaml.</p>
</blockquote>
</li>
<li>
<p>Verify that the guestbook deployment is running:</p>
<div class="highlight"><pre><span></span><code>kubectl get deploy
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>kubectl get deploy
<span class="go">NAME           READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="go">guestbook-v2   3/3     3            3           24s</span>
<span class="go">redis-master   1/1     1            1           5m37s</span>
<span class="go">redis-slave    2/2     2            2           3m58s</span>
</code></pre></div>
</li>
<li>
<p>Verify that the guestbook pods are running (it might take up to thirty seconds to create the pods):</p>
<div class="highlight"><pre><span></span><code>kubectl get pods
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>kubectl get pods
<span class="go">NAME                            READY   STATUS    RESTARTS   AGE</span>
<span class="go">guestbook-v2-75fbf9c4d-c2m6s    1/1     Running   0          25s</span>
<span class="go">guestbook-v2-75fbf9c4d-nx2f2    1/1     Running   0          25s</span>
<span class="go">guestbook-v2-75fbf9c4d-p2x97    1/1     Running   0          25s</span>
<span class="go">redis-master-7b7968db76-8mjqg   1/1     Running   0          5m10s</span>
<span class="go">redis-slave-6944587c87-4gvgj    1/1     Running   0          2m58s</span>
<span class="go">redis-slave-6944587c87-h66wp    1/1     Running   0          2m58s</span>
</code></pre></div>
<p>Result: You see a single Redis master, two Redis slaves, and three guestbook pods.</p>
</li>
</ol>
<h2 id="create-and-expose-the-guestbook-service">Create and expose the guestbook service<a class="headerlink" href="#create-and-expose-the-guestbook-service" title="Permanent link">&para;</a></h2>
<p>Just like the others, we create a service to group the guestbook pods. Since guestbook uses a web application protocol we will expose it for access outside the cluster using a service of type `NodePort.</p>
<ol>
<li>
<p>Use the <a href="../../v2/guestbook-service.yaml">guestbook-service.yaml</a> file to create the guestbook service:</p>
<div class="highlight"><pre><span></span><code>kubectl create -f guestbook-service.yaml
</code></pre></div>
</li>
<li>
<p>Verify that the guestbook service is up by listing the services in the cluster:</p>
<div class="highlight"><pre><span></span><code>kubectl get services
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>kubectl get services
<span class="go">NAME           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span>
<span class="go">guestbook      NodePort    172.21.128.59   &lt;none&gt;        3000:30796/TCP   35s</span>
<span class="go">kubernetes     ClusterIP   172.21.0.1      &lt;none&gt;        443/TCP          8h</span>
<span class="go">redis-master   ClusterIP   172.21.36.3     &lt;none&gt;        6379/TCP         13m</span>
<span class="go">redis-slave    ClusterIP   172.21.251.35   &lt;none&gt;        6379/TCP         11m</span>
</code></pre></div>
<p>Result: The service is created, and exposed as a NodePort and in this example is listening on <code>30796</code>.</p>
</li>
</ol>
<h2 id="create-the-analyzer-pod">Create the analyzer pod<a class="headerlink" href="#create-the-analyzer-pod" title="Permanent link">&para;</a></h2>
<p>This is a simple Python Flask application that creates a POST endpoint <code>/tone</code> and takes the input text and sends it to the Watson Tone Analyzer service. In the <a href="../../v2/analyzer-deployment.yaml">analyzer-deployment.yaml</a> the spec for the pod defines environment variables for the service credentials by reading the secret <code>binding-tone</code> created by the IBM Cloud operator.</p>
<ol>
<li>
<p>Use the <a href="../../v2/analyzer-deployment.yaml">analyzer-deployment.yaml</a> file to create the analyzer replication controller:</p>
<div class="highlight"><pre><span></span><code>kubectl create -f analyzer-deployment.yaml
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>kubectl create -f analyzer-deployment.yaml
<span class="go">deployment.apps/analyzer created</span>
</code></pre></div>
</li>
</ol>
<p>Tip: If you want to modify the analyzer code it can be found in the <code>analyzer</code> directory, along with its Makefile. If you have pushed your custom image be sure to update the <code>image</code> property accordingly in the analyzer-deployment.yaml.</p>
<ol>
<li>
<p>Verify that the guestbook deployment is running:</p>
<div class="highlight"><pre><span></span><code>kubectl get deploy
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>kubectl get deploy
<span class="go">NAME           READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="go">analyzer       0/1     1            0           16s</span>
<span class="go">guestbook-v2   3/3     3            3           14m</span>
<span class="go">redis-master   1/1     1            1           19m</span>
<span class="go">redis-slave    2/2     2            2           17m</span>
</code></pre></div>
</li>
</ol>
<h2 id="create-the-analyzer-service">Create the analyzer service<a class="headerlink" href="#create-the-analyzer-service" title="Permanent link">&para;</a></h2>
<p>Create a service so that the guestbook application can call the analyzer pod</p>
<ol>
<li>
<p>Use the <a href="../../v2/analyzer-service.yaml">analyzer-service.yaml</a> file to create the analyzer service:</p>
<div class="highlight"><pre><span></span><code>kubectl create -f analyzer-service.yaml
</code></pre></div>
</li>
<li>
<p>To verify that the analyzer service is up, list the services created in the cluster:</p>
<div class="highlight"><pre><span></span><code>kubectl get services
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>kubectl get services
<span class="go">NAME           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span>
<span class="go">analyzer       ClusterIP   172.21.125.6    &lt;none&gt;        80/TCP           38s</span>
<span class="go">guestbook      NodePort    172.21.128.59   &lt;none&gt;        3000:30796/TCP   5m54s</span>
<span class="go">kubernetes     ClusterIP   172.21.0.1      &lt;none&gt;        443/TCP          8h</span>
<span class="go">redis-master   ClusterIP   172.21.36.3     &lt;none&gt;        6379/TCP         19m</span>
<span class="go">redis-slave    ClusterIP   172.21.251.35   &lt;none&gt;        6379/TCP         16m</span>
</code></pre></div>
<p>Result: The service is created</p>
</li>
</ol>
<h2 id="view-the-guestbook">View the guestbook<a class="headerlink" href="#view-the-guestbook" title="Permanent link">&para;</a></h2>
<p>You can now play with the guestbook that you just created by opening it in a browser, use the IP and NodePort for your deployment. Find the IP address for your cluster using this command (use the Public IP):</p>
<div class="highlight"><pre><span></span><code>ibmcloud ks workers -c mycluster
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>ibmcloud ks workers -c mycluster
<span class="go">ID                                                     Public IP         Private IP      Flavor   State    Status   Zone    Version</span>
<span class="go">kube-bmotc1dd0i2tk1jloing-mycluster-default-0000008d   184.172.252.167   10.76.195.211   free     normal   Ready    hou02   1.14.7_1535</span>
</code></pre></div>
<p>In this example the IP is: <code>184.172.252.167</code></p>
<p>Get the nodeport (it will be different from the first exercise):</p>
<div class="highlight"><pre><span></span><code>kubectl get service guestbook
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>kubectl get service guestbook
<span class="go">NAME        TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE</span>
<span class="go">guestbook   NodePort   172.21.64.67   &lt;none&gt;        3000:30796/TCP   9m16s</span>
</code></pre></div>
<p>For this value of IP address and NodePort, you would use a url like <code>http://184.172.252.167:30796</code> to access the guestbook.</p>
<p>Result: The guestbook displays in your browser:</p>
<p><img alt="Guestbook" src="../assets/assets/guestbook-nodeport.png" /></p>
<h2 id="cleanup">Cleanup<a class="headerlink" href="#cleanup" title="Permanent link">&para;</a></h2>
<p>After you're done playing with the guestbook, you can cleanup by deleting the guestbook service and removing the associated resources that were created, including routes, forwarding rules, target pools, and Kubernetes replication controllers and services.</p>
<p>Delete all the resources sourced by the files in the <code>v2</code> directory:</p>
<div class="highlight"><pre><span></span><code>kubectl delete -f .
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>kubectl delete -f .
<span class="go">deployment.apps &quot;analyzer&quot; deleted</span>
<span class="go">service &quot;analyzer&quot; deleted</span>
<span class="go">deployment.apps &quot;guestbook-v2&quot; deleted</span>
<span class="go">service &quot;guestbook&quot; deleted</span>
<span class="go">deployment.apps &quot;redis-master&quot; deleted</span>
<span class="go">service &quot;redis-master&quot; deleted</span>
<span class="go">deployment.apps &quot;redis-slave&quot; deleted</span>
<span class="go">service &quot;redis-slave&quot; deleted</span>
</code></pre></div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../exercise-4/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Creating an instance of Tone Analyzer
              </div>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2021 IBM Developer
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://github.com/ibm" target="_blank" rel="noopener" title="github.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://twitter.com/ibmdeveloper" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://www.linkedin.com/company/ibm/" target="_blank" rel="noopener" title="www.linkedin.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://www.youtube.com/user/developerworks" target="_blank" rel="noopener" title="www.youtube.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://dev.to/ibmdeveloper" target="_blank" rel="noopener" title="dev.to" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M120.12 208.29c-3.88-2.9-7.77-4.35-11.65-4.35H91.03v104.47h17.45c3.88 0 7.77-1.45 11.65-4.35 3.88-2.9 5.82-7.25 5.82-13.06v-69.65c-.01-5.8-1.96-10.16-5.83-13.06zM404.1 32H43.9C19.7 32 .06 51.59 0 75.8v360.4C.06 460.41 19.7 480 43.9 480h360.2c24.21 0 43.84-19.59 43.9-43.8V75.8c-.06-24.21-19.7-43.8-43.9-43.8zM154.2 291.19c0 18.81-11.61 47.31-48.36 47.25h-46.4V172.98h47.38c35.44 0 47.36 28.46 47.37 47.28l.01 70.93zm100.68-88.66H201.6v38.42h32.57v29.57H201.6v38.41h53.29v29.57h-62.18c-11.16.29-20.44-8.53-20.72-19.69V193.7c-.27-11.15 8.56-20.41 19.71-20.69h63.19l-.01 29.52zm103.64 115.29c-13.2 30.75-36.85 24.63-47.44 0l-38.53-144.8h32.57l29.71 113.72 29.57-113.72h32.58l-38.46 144.8z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.18f0862e.min.js"></script>
      <script src="../assets/javascripts/bundle.994580cf.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: ['navigation.instant', 'navigation.expand'],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.9c0e82ba.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>